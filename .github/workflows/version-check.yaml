name: Version Bump Check

on:
  pull_request:
    branches: [main]

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check version was bumped
        run: |
          PR_VERSION=$(python -c "
          import re
          with open('pyproject.toml') as f:
              match = re.search(r'^version\s*=\s*\"(.+?)\"', f.read(), re.MULTILINE)
              print(match.group(1))
          ")

          BASE_VERSION=$(git show origin/${{ github.base_ref }}:pyproject.toml | python -c "
          import sys, re
          match = re.search(r'^version\s*=\s*\"(.+?)\"', sys.stdin.read(), re.MULTILINE)
          print(match.group(1))
          ")

          echo "Base version: $BASE_VERSION"
          echo "PR version:   $PR_VERSION"

          if [ "$PR_VERSION" = "$BASE_VERSION" ]; then
            echo "::error::Version in pyproject.toml has not been bumped (still $BASE_VERSION)"
            exit 1
          fi

          echo "Version bumped from $BASE_VERSION to $PR_VERSION"
